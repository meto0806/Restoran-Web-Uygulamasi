<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siparişler | Admin</title>
    <link rel="stylesheet" href="/deneme/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .order-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #444;
        }

        .info-box h4 {
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .info-box p {
            color: #ccc;
            font-size: 1.1rem;
            margin: 0;
            line-height: 1.4;
        }

        .modal-content {
            width: 600px !important;
        }
    </style>
</head>

<body class="admin-page">

    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
        preload="auto"></audio>

    <div class="sidebar">
        <div class="sidebar-brand">
            <span class="fa-solid fa-utensils"></span>
            <h2>Admin</h2>
        </div>
        <div class="sidebar-menu">
            <ul>
                <li><a href="/admin/adminpanel.html"><span class="fa-solid fa-gauge-high"></span> <span>Panel</span></a>
                </li>
                <li><a href="/admin/admin-orders.html" class="active"><span class="fa-solid fa-bag-shopping"></span>
                        <span>Siparişler</span></a></li>
                <li><a href="/admin/admin-products.html"><span class="fa-solid fa-burger"></span>
                        <span>Ürünler</span></a></li>
                <li><a href="/admin/admin-reservations.html"><span class="fa-solid fa-calendar-days"></span>
                        <span>Rezervasyonlar</span></a></li>
                <li><a href="/admin/admin-customers.html"><span class="fa-solid fa-users"></span>
                        <span>Müşteriler</span></a></li>
                <li><a href="/admin/admin-messages.html"><span class="fa-solid fa-message"></span>
                        <span>Mesajlar</span></a></li>
                <li><a href="/admin/admin-logs.html"><span class="fa-solid fa-clipboard-list"></span> <span>İşlem
                            Logları</span></a></li>
                <li><a href="/admin/admin-settings.html"><span class="fa-solid fa-gear"></span> <span>Ayarlar</span></a>
                </li>
                <li><a href="/"><span class="fa-solid fa-house"></span> <span>Siteye Dön</span></a></li>
            </ul>
        </div>
        <div class="logout-container">
            <div class="logout-btn" onclick="window.location.href='/logout'"><i
                    class="fa-solid fa-power-off"></i><span>Çıkış Yap</span></div>
        </div>
    </div>

    <div class="main-content">
        <header>
            <h2><i class="fa-solid fa-bag-shopping"></i> Sipariş Yönetimi</h2>
            <div class="user-wrapper">
                <img src="" id="admin-avatar" alt="Profil" style="object-fit: cover;">
                <div>
                    <h4 id="admin-name">Yükleniyor...</h4><small id="admin-role">...</small>
                </div>
            </div>
        </header>

        <div class="recent-grid">
            <div class="card">
                <div class="card-header">
                    <h3>Sipariş Takibi</h3>
                    <div style="display: flex; gap: 10px;">
                        <span id="auto-refresh-status"
                            style="font-size: 0.8rem; color: #aaa; align-self: center;">Otomatik yenileniyor...</span>
                        <button onclick="fetchOrders()" class="button" style="padding: 8px 15px;"><i
                                class="fa-solid fa-rotate"></i> Yenile</button>
                    </div>
                </div>

                <div class="card-body">
                    <div class="tabs-container">
                        <button class="tab-btn active" onclick="switchTab('active')" id="tab-active">
                            <i class="fa-solid fa-fire"></i> Aktif Siparişler
                        </button>
                        <button class="tab-btn" onclick="switchTab('history')" id="tab-history">
                            <i class="fa-solid fa-clock-rotate-left"></i> Geçmiş Siparişler
                        </button>
                    </div>

                    <table width="100%">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Müşteri / Tel</th>
                                <th>Tarih</th>
                                <th>Tutar</th>
                                <th>Ödeme</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table">
                            <tr>
                                <td colspan="7" style="text-align: center;">Yükleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="order-detail-modal" class="modal-overlay">
        <div class="modal-content">
            <span onclick="modalKapat()" class="close-modal">&times;</span>
            <h2 id="modal-title"
                style="margin-bottom: 20px; color: var(--text-main); border-bottom: 2px solid var(--primary); display:inline-block; padding-bottom: 5px;">
                Sipariş Detayı</h2>
            <div id="modal-info-area"></div>
            <h4 style="color: #fff; margin-bottom: 10px;">Sipariş İçeriği:</h4>
            <div id="modal-body" style="font-size: 1.2rem; color: #ddd; max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        let allOrders = [];
        let currentTab = 'active'; // Varsayılan sekme: Aktif
        let lastMaxId = 0; // Ses çalmak için son sipariş ID'sini tutar

        document.addEventListener('DOMContentLoaded', () => {
            fetchOrders();
            updateAdminProfile();
            setInterval(fetchOrders, 30000); // 30 sn'de bir yenile
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api/admin/settings')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.settings && data.settings.site_favicon) {
                        let link = document.querySelector("link[rel~='icon']");
                        if (!link) {
                            link = document.createElement('link');
                            link.rel = 'icon';
                            document.getElementsByTagName('head')[0].appendChild(link);
                        }
                        link.href = data.settings.site_favicon;
                    }
                })
                .catch(err => console.error("Favicon yüklenemedi", err));
        });

        // 1. SEKME DEĞİŞTİRME
        function switchTab(tabName) {
            currentTab = tabName;

            // Butonların aktiflik durumunu güncelle
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');

            // Tabloyu yeniden çiz (Server'a gitmeden hafızadan)
            renderOrdersTable();
        }

        // 2. VERİ ÇEKME VE SES KONTROLÜ
        async function fetchOrders() {
            const statusLabel = document.getElementById('auto-refresh-status');
            if (statusLabel) statusLabel.innerText = 'Veri çekiliyor...';

            try {
                const res = await fetch('/api/admin/orders');
                const data = await res.json();

                if (statusLabel) setTimeout(() => statusLabel.innerText = 'Otomatik yenileniyor (30sn)', 1000);

                if (data.orders.length > 0) {
                    allOrders = data.orders;

                    // --- SESLİ BİLDİRİM MANTIĞI ---
                    // Listedeki en büyük ID'yi bul
                    const maxId = Math.max(...data.orders.map(o => o.id));

                    // Eğer sayfa ilk açılış değilse (lastMaxId != 0) ve yeni büyük ID geldiyse ses çal
                    if (lastMaxId !== 0 && maxId > lastMaxId) {
                        playNotificationSound();
                    }
                    lastMaxId = maxId; // Son ID'yi güncelle

                    renderOrdersTable();
                } else {
                    document.getElementById('orders-table').innerHTML = '<tr><td colspan="7" style="text-align:center;">Sipariş yok.</td></tr>';
                }
            } catch (e) { console.error(e); }
        }

        function playNotificationSound() {
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.play().catch(e => console.log("Ses çalma engellendi (Kullanıcı etkileşimi lazım):", e));
            }
        }

        // 3. TABLOYU ÇİZME (FİLTRE VE RENK DAHİL)
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table');
            tbody.innerHTML = '';

            // Sekmeye göre filtrele
            const filteredOrders = allOrders.filter(order => {
                const isFinished = (order.status === 'Teslim Edildi' || order.status === 'İptal');
                if (currentTab === 'active') return !isFinished; // Aktif sekmesi: Bitmemişler
                else return isFinished; // Geçmiş sekmesi: Bitenler
            });

            if (filteredOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">Bu alanda sipariş yok.</td></tr>';
                return;
            }

            filteredOrders.forEach(order => {
                const tarih = new Date(order.created_at).toLocaleDateString('tr-TR') + ' ' + new Date(order.created_at).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

                // SATIR RENKLENDİRME SINIFI
                let rowClass = '';
                if (order.status === 'İptal') rowClass = 'status-iptal';
                else if (order.status === 'Teslim Edildi') rowClass = 'status-teslim';
                else if (order.status === 'Onay Bekliyor' || order.status === 'Hazırlanıyor') rowClass = 'status-yeni';

                const phoneDisplay = order.phone ? `<br><small style="color:#aaa;"><i class="fa-solid fa-phone"></i> ${order.phone}</small>` : '';

                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td>#${order.id}</td>
                        <td><strong>${order.name} ${order.surname}</strong>${phoneDisplay}</td>
                        <td>${tarih}</td>
                        <td style="color: var(--primary); font-weight: bold;">${formatCurrency(order.total_amount)}</td>
                        <td>${order.payment_method}</td>
                        <td>
                            <select onchange="updateStatus(${order.id}, this.value)" 
                                    style="padding: 6px; border-radius: 6px; background: #252525; color: #fff; border: 1px solid #444; cursor: pointer; font-weight: bold;">
                                <option value="Hazırlanıyor" ${order.status === 'Hazırlanıyor' ? 'selected' : ''}>Hazırlanıyor</option>
                                <option value="Yolda" ${order.status === 'Yolda' ? 'selected' : ''}>Yolda</option>
                                <option value="Teslim Edildi" ${order.status === 'Teslim Edildi' ? 'selected' : ''}>Teslim Edildi</option>
                                <option value="İptal" ${order.status === 'İptal' ? 'selected' : ''}>İptal</option>
                            </select>
                        </td>
                        <td>
                            <div style="display:flex; gap: 5px;">
                                <button class="action-btn" onclick="showDetails(${order.id})" style="background: #3498db; color: white; padding: 6px 10px;" title="Detay"><i class="fa-solid fa-eye"></i></button>
                                <button class="action-btn" onclick="printOrder(${order.id})" style="background: #2ecc71; color: white; padding: 6px 10px;" title="Fiş Yazdır"><i class="fa-solid fa-print"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        async function updateStatus(orderId, newStatus) {
            try {
                const res = await fetch('/api/admin/update-order-status', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: orderId, status: newStatus })
                });
                const result = await res.json();
                if (result.success) {
                    // Durum değişince tabloyu güncelle (Örn: Aktiften geçmişe düşmesi için)
                    // Önce mevcut dizideki veriyi güncelle
                    const order = allOrders.find(o => o.id === orderId);
                    if (order) order.status = newStatus;
                    renderOrdersTable();
                } else { alert('Hata oluştu.'); }
            } catch (err) { console.error(err); }
        }

        async function showDetails(orderId) {
            const modal = document.getElementById('order-detail-modal');
            const infoArea = document.getElementById('modal-info-area');
            const body = document.getElementById('modal-body');
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            infoArea.innerHTML = `
                <div class="order-info-grid">
                    <div class="info-box">
                        <h4>Müşteri Bilgileri</h4>
                        <p><strong>${order.name} ${order.surname}</strong></p>
                        <p><i class="fa-solid fa-phone"></i> ${order.phone || 'Yok'}</p>
                        <p style="margin-top:5px; color:#aaa;">Ödeme: ${order.payment_method}</p>
                    </div>
                    <div class="info-box">
                        <h4>Teslimat Adresi</h4>
                        <p><strong>${order.addr_title || 'Ev'}</strong> - ${order.city}/${order.district}</p>
                        <p style="font-size: 1rem; margin-top: 5px;">${order.address_text}</p>
                    </div>
                </div>`;
            body.innerHTML = 'Yükleniyor...';
            modal.style.display = 'flex';

            try {
                const res = await fetch('/api/get-order-details', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ orderId })
                });
                const data = await res.json();
                if (data.success) {
                    let html = '<ul style="padding: 0; list-style:none;">';
                    data.items.forEach(item => {
                        html += `
                            <li style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span><strong style="color: var(--primary);">${item.quantity}x</strong> ${item.product_name}</span>
                                <span>${formatCurrency(item.price * item.quantity)}</span>
                            </li>`;
                    });
                    html += `
                        <li style="display: flex; justify-content: space-between; padding: 15px 0; font-size: 1.4rem; font-weight: bold; color: #2ecc71;">
                            <span>TOPLAM</span><span>${formatCurrency(order.total_amount)}</span>
                        </li></ul>`;
                    body.innerHTML = html;
                }
            } catch (err) { body.innerHTML = 'Hata.'; }
        }

        async function printOrder(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            try {
                const res = await fetch('/api/get-order-details', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ orderId })
                });
                const data = await res.json();
                if (data.success) {
                    let itemsHtml = '';
                    data.items.forEach(item => {
                        itemsHtml += `<tr><td style="padding: 5px 0; border-bottom: 1px dashed #000;">${item.quantity}x ${item.product_name}</td><td style="padding: 5px 0; border-bottom: 1px dashed #000; text-align: right;">${formatCurrency(item.price * item.quantity)}</td></tr>`;
                    });
                    const printWindow = window.open('', '', 'height=600,width=400');
                    const tarih = new Date(order.created_at).toLocaleString('tr-TR');
                    printWindow.document.write(`<html><head><title>Sipariş #${order.id}</title><style>body { font-family: 'Courier New', monospace; font-size: 12px; margin: 0; padding: 10px; } .header { text-align: center; margin-bottom: 10px; } table { width: 100%; border-collapse: collapse; } .total { text-align: right; font-size: 16px; font-weight: bold; margin-top: 10px; } </style></head><body><div class="header"><h2>RESTORAN</h2><p>Fiş</p></div><div><strong>No:</strong> #${order.id}<br><strong>Müşteri:</strong> ${order.name}<br><strong>Adres:</strong> ${order.address_text}</div><br><table>${itemsHtml}</table><div class="total">TOPLAM: ${formatCurrency(order.total_amount)}</div></body></html>`);
                    printWindow.document.close(); printWindow.focus();
                    setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
                }
            } catch (e) { alert("Yazdırma hatası."); }
        }

        function modalKapat() { document.getElementById('order-detail-modal').style.display = 'none'; }
        function formatCurrency(amount) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(amount); }
        async function updateAdminProfile() { /* Profil kodu aynı */ }
    </script>
</body>

</html>