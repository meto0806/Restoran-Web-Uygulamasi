<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetim Paneli | Dashboard</title>
    <link rel="stylesheet" href="/deneme/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* DASHBOARD ÖZEL STİLLERİ */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .d-card {
            padding: 25px;
            border-radius: 12px;
            color: #fff;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .d-card:hover {
            transform: translateY(-5px);
        }

        .d-card h3 {
            font-size: 2.5rem;
            margin: 10px 0;
            font-weight: bold;
        }

        .d-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .d-card i {
            position: absolute;
            right: 20px;
            bottom: 20px;
            font-size: 4rem;
            opacity: 0.2;
        }

        /* Kart Renkleri */
        .bg-gradient-1 {
            background: linear-gradient(45deg, #FF512F, #DD2476);
        }

        /* Ciro - Kırmızı/Turuncu */
        .bg-gradient-2 {
            background: linear-gradient(45deg, #11998e, #38ef7d);
        }

        /* Sipariş - Yeşil */
        .bg-gradient-3 {
            background: linear-gradient(45deg, #3a7bd5, #00d2ff);
        }

        /* Müşteri - Mavi */
        .bg-gradient-4 {
            background: linear-gradient(45deg, #f12711, #f5af19);
        }

        /* Aktif - Sarı */

        /* Grafik Alanı */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            /* Sol grafik geniş, sağ dar */
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-box {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* --- YENİ EKLENEN: SWITCH CSS --- */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #333;
            padding: 5px 15px;
            border-radius: 8px;
            margin-right: 15px;
            border: 1px solid #444;
        }

        .switch-label {
            color: #fff;
            font-weight: bold;
            font-size: 1rem;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e74c3c;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #2ecc71;
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        /* ------------------------------- */

        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            /* Mobilde alt alta */
        }
    </style>
</head>

<body class="admin-page">

    <div class="sidebar">
        <div class="sidebar-brand">
            <span class="fa-solid fa-utensils"></span>
            <h2>Admin</h2>
        </div>
        <div class="sidebar-menu">
            <ul>
                <li><a href="/admin/adminpanel.html" class="active"><span class="fa-solid fa-gauge-high"></span>
                        <span>Panel</span></a></li>
                <li><a href="/admin/admin-orders.html"><span class="fa-solid fa-bag-shopping"></span>
                        <span>Siparişler</span></a></li>
                <li><a href="/admin/admin-products.html"><span class="fa-solid fa-burger"></span>
                        <span>Ürünler</span></a></li>
                <li><a href="/admin/admin-reservations.html"><span class="fa-solid fa-calendar-days"></span>
                        <span>Rezervasyonlar</span></a></li>
                <li><a href="/admin/admin-customers.html"><span class="fa-solid fa-users"></span>
                        <span>Müşteriler</span></a></li>
                <li><a href="/admin/admin-messages.html"><span class="fa-solid fa-message"></span>
                        <span>Mesajlar</span></a></li>
                <li><a href="/admin/admin-logs.html"><span class="fa-solid fa-clipboard-list"></span> <span>İşlem
                            Logları</span></a></li>
                <li><a href="/admin/admin-settings.html"><span class="fa-solid fa-gear"></span> <span>Ayarlar</span></a>
                </li>
                <li><a href="/"><span class="fa-solid fa-house"></span> <span>Siteye Dön</span></a></li>
            </ul>
        </div>
        <div class="logout-container">
            <div class="logout-btn" onclick="window.location.href='/logout'"><i
                    class="fa-solid fa-power-off"></i><span>Çıkış Yap</span></div>
        </div>
    </div>

    <div class="main-content">
        <header>
            <div style="display: flex; align-items: center; gap: 15px;">
                <h2><i class="fa-solid fa-gauge-high"></i> Kontrol Paneli</h2>

                <div class="switch-container">
                    <span class="switch-label" id="shop-status-text">Yükleniyor...</span>
                    <label class="switch">
                        <input type="checkbox" id="shop_toggle" onchange="toggleShopStatus()">
                        <span class="slider"></span>
                    </label>
                </div>

                <select id="time-filter" onchange="loadDashboardData()"
                    style="padding: 12px; border-radius: 8px; border: none; background: #333; color: white; cursor: pointer; font-size: 1.3rem; font-weight: 500;">
                    <option value="daily">Bugün</option>
                    <option value="weekly">Bu Hafta</option>
                    <option value="monthly">Bu Ay</option>
                    <option value="yearly">Bu Yıl</option>
                    <option value="all" selected>Tüm Zamanlar</option>
                </select>

                <button onclick="downloadExcel()"
                    style="margin-left: 10px; padding: 12px 20px; border-radius: 8px; border: none; background: #2ecc71; color: white; cursor: pointer; font-size: 1.1rem; font-weight: bold;">
                    <i class="fa-solid fa-file-excel"></i> Excel İndir
                </button>
            </div>

            <div class="user-wrapper">
                <img src="" id="admin-avatar" alt="Profil" style="object-fit: cover;">
                <div>
                    <h4 id="admin-name">Yükleniyor...</h4><small id="admin-role">...</small>
                </div>
            </div>
        </header>

        <div class="dashboard-cards">
            <div class="d-card bg-gradient-1">
                <p>Toplam Kazanç</p>
                <h3 id="card-revenue">0 TL</h3>
                <i class="fa-solid fa-wallet"></i>
            </div>
            <div class="d-card bg-gradient-2">
                <p>Toplam Sipariş</p>
                <h3 id="card-orders">0</h3>
                <i class="fa-solid fa-bag-shopping"></i>
            </div>
            <div class="d-card bg-gradient-4">
                <p>Aktif Siparişler</p>
                <h3 id="card-active-orders">0</h3>
                <i class="fa-solid fa-motorcycle"></i>
            </div>
            <div class="d-card bg-gradient-3">
                <p>Kayıtlı Müşteri</p>
                <h3 id="card-users">0</h3>
                <i class="fa-solid fa-users"></i>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-box">
                <h3 style="margin-bottom: 15px; color: var(--text-main);">Son 7 Günlük Kazanç</h3>
                <canvas id="revenueChart"></canvas>
            </div>
            <div class="chart-box">
                <h3 style="margin-bottom: 15px; color: var(--text-main); font-size: 1.6rem;">Sipariş Özeti</h3>
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <div class="recent-grid">
            <div class="card">
                <div class="card-header">
                    <h3>Son Gelen Siparişler</h3>
                    <button onclick="window.location.href='/admin/admin-orders.html'" class="button">Tümünü Gör <i
                            class="fa-solid fa-arrow-right"></i></button>
                </div>
                <div class="card-body">
                    <table width="100%">
                        <thead>
                            <tr>
                                <th>Müşteri</th>
                                <th>Tarih</th>
                                <th>Tutar</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders-table">
                            <tr>
                                <td colspan="4" style="text-align:center;">Yükleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="/deneme/script.js"></script>

    <script>
        // Grafiklerin referanslarını tutmak için global değişkenler
        let revenueChartInstance = null;
        let statusChartInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            updateAdminProfile();
            checkShopStatus(); // YENİ: Dükkan durumu kontrolü
        });

        // --- YENİ: DÜKKAN DURUMU FONKSİYONLARI ---
        async function checkShopStatus() {
            try {
                const res = await fetch('/api/admin/settings');
                const data = await res.json();
                if (data.success && data.settings) {
                    const isOpen = data.settings.shop_is_open === 'true';
                    updateSwitchVisuals(isOpen);
                }
            } catch (e) { console.error("Dükkan durumu alınamadı", e); }
        }

        async function toggleShopStatus() {
            const toggle = document.getElementById('shop_toggle');
            const isChecked = toggle.checked;

            // Görseli güncelle
            updateSwitchVisuals(isChecked);

            // Sunucuya kaydet
            const formData = new FormData();
            formData.append('shop_is_open', isChecked ? 'true' : 'false');

            try {
                await fetch('/api/admin/update-settings', {
                    method: 'POST',
                    body: formData
                });
                // Başarılı
            } catch (e) {
                alert("Durum güncellenemedi!");
                toggle.checked = !isChecked; // Hata olursa eski haline döndür
                updateSwitchVisuals(!isChecked);
            }
        }

        function updateSwitchVisuals(isOpen) {
            const toggle = document.getElementById('shop_toggle');
            const label = document.getElementById('shop-status-text');

            toggle.checked = isOpen;
            if (isOpen) {
                label.innerText = "AÇIK";
                label.style.color = "#2ecc71"; // Yeşil yazı
            } else {
                label.innerText = "KAPALI";
                label.style.color = "#e74c3c"; // Kırmızı yazı
            }
        }
        // ------------------------------------------

        async function loadDashboardData() {
            // Seçili zaman aralığını al
            const range = document.getElementById('time-filter').value;

            try {
                // Sunucuya ?range=weekly gibi parametre gönderiyoruz
                const res = await fetch(`/api/admin/dashboard-stats?range=${range}`);
                const data = await res.json();

                if (data.success) {
                    const s = data.stats;

                    // 1. KARTLARI GÜNCELLE (Animasyonlu)
                    const currentOrders = parseInt(document.getElementById("card-orders").innerText) || 0;
                    animateValue("card-orders", currentOrders, s.total_orders, 500);

                    const currentUsers = parseInt(document.getElementById("card-users").innerText) || 0;
                    animateValue("card-users", currentUsers, s.total_users, 500);

                    const currentActive = parseInt(document.getElementById("card-active-orders").innerText) || 0;
                    animateValue("card-active-orders", currentActive, s.active_orders, 500);

                    // Ciro Formatlama
                    document.getElementById('card-revenue').innerText = formatCurrency(s.total_revenue);

                    // 2. SON SİPARİŞLER TABLOSUNU DOLDUR
                    const tbody = document.getElementById('recent-orders-table');
                    tbody.innerHTML = '';
                    if (data.recentOrders.length === 0) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Henüz sipariş yok.</td></tr>';

                    data.recentOrders.forEach(o => {
                        const tarih = new Date(o.created_at).toLocaleDateString('tr-TR');
                        let statusColor = '#333';
                        if (o.status === 'Teslim Edildi') statusColor = '#27ae60';
                        else if (o.status === 'İptal') statusColor = '#c0392b';
                        else statusColor = '#e67e22'; // Bekleyenler

                        tbody.innerHTML += `
                            <tr>
                                <td>${o.name} ${o.surname}</td>
                                <td>${tarih}</td>
                                <td style="color:var(--primary); font-weight:bold;">${formatCurrency(o.total_amount)}</td>
                                <td><span style="background:${statusColor}; color:white; padding:3px 8px; border-radius:4px; font-size:1.3rem;">${o.status}</span></td>
                            </tr>
                        `;
                    });

                    // 3. GRAFİKLERİ ÇİZ
                    initCharts(data.chartData, s);
                }
            } catch (e) { console.error("Veri yüklenemedi", e); }
        }

        function initCharts(revenueData, stats) {
            if (revenueChartInstance) { revenueChartInstance.destroy(); }
            if (statusChartInstance) { statusChartInstance.destroy(); }

            // A) ÇİZGİ GRAFİK (Ciro)
            const ctxRev = document.getElementById('revenueChart').getContext('2d');
            const labels = revenueData.map(d => d.day_label);
            const values = revenueData.map(d => d.daily_total);

            revenueChartInstance = new Chart(ctxRev, {
                type: 'line',
                data: {
                    labels: labels.length ? labels : ['Veri Yok'],
                    datasets: [{
                        label: 'Günlük Ciro (TL)',
                        data: values.length ? values : [0],
                        borderColor: '#e67e22',
                        backgroundColor: 'rgba(230, 126, 34, 0.2)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#444' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // B) PASTA GRAFİK (Durum Dağılımı)
            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            statusChartInstance = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Tamamlanan', 'Aktif', 'Diğer'],
                    datasets: [{
                        data: [stats.total_orders - stats.active_orders, stats.active_orders, 0],
                        backgroundColor: ['#2ecc71', '#f1c40f', '#95a5a6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#ccc', font: { size: 16 } }
                        }
                    }
                }
            });
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            const timer = setInterval(function () {
                current += increment;
                obj.innerHTML = current;
                if (current == end) clearInterval(timer);
            }, stepTime > 0 ? stepTime : 10);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(amount);
        }

        async function updateAdminProfile() {
            const imgEl = document.getElementById('admin-avatar');
            const nameEl = document.getElementById('admin-name');
            const roleEl = document.getElementById('admin-role');
            if (!imgEl || !nameEl) return;
            try {
                const res = await fetch('/api/check-auth');
                const data = await res.json();
                if (data.success && data.user) {
                    const u = data.user;
                    const fullName = (u.name && u.surname) ? `${u.name} ${u.surname}` : u.username;
                    nameEl.innerText = fullName;
                    roleEl.innerText = u.email;
                    imgEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&background=random&color=fff&bold=true&size=128`;
                }
            } catch (err) { }
        }

        function downloadExcel() {
            const range = document.getElementById('time-filter').value;
            window.location.href = `/api/admin/export-orders?range=${range}`;
        }
    </script>
</body>

</html>